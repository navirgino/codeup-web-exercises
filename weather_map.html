<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.css' rel='stylesheet'/>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro&display=swap" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="materialize/css/materialize.min.css" media="screen,projection"/>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <style>

        body {
            background-color: #546E7A;
            font-family: 'Source Serif Pro', serif;
        }

        .card-content {
            font-size: 20px;
        }

        #map {
            width: 100%;

            height: 80vh;
        }

        .empty {
            height: 50px;
        }

        .card-content {
            height: 50vh;
            background-color: rgba(98, 255, 240, 0.24);
        }

        .nav-wrapper {
            font-size: 50px;
        }


    </style>
    <title>Weather Map</title>

</head>
<div class="nav-container">
    <!--nav bar below-->

    <nav class="nav-wrapper blue-grey">
        My Weather Map

    </nav>
    <!--search form below-->
    <form>
        <div class="input-field">
            <input id="input" type="search" placeholder="Show me the weather in... city, zip, or place" required>
            <button id="geoSearch" class="btn waves-effect waves-light" type="submit" name="action">Submit
                <i class="material-icons right">search</i></button>
            <label class="label-icon" for="input"></label>
            <i class="material-icons">close</i>
        </div>
    </form>
    <!--search form end-->
    </nav>
</div>


<!--cards/loader container-->
<div class="container center-align">

    <!--loader below-->
    <div class="preloader-wrapper big active">
        <div class="spinner-layer spinner-white-only">
            <div class="circle-clipper left">
                <div class="circle"></div>
            </div>
            <div class="gap-patch">
                <div class="circle"></div>
            </div>
            <div class="circle-clipper right">
                <div class="circle"></div>
            </div>
        </div>
    </div>
    <!--cards in here-->
    <div class="row"></div>

</div>


<!--put empty div set ht and width so map doesn't drop up-->
<div class="empty"></div>

<!--MAPBOX BELOW-->
<div id="map"></div>


<!--MAPBOX DARKSKY JS-->

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.0/mapbox-gl.js'></script>

<!-- Compiled and minified JavaScript -->
<script src="js/jquery-2.2.4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="js/keys.js"></script>
<script src="js/mapbox-geocoder-utils.js"></script>


<script>
    $(document).ready(function () {
        "use strict";

        //i think we have to wrap darksky in mapbox but let's try..

        //initialize mapbox
        mapboxgl.accessToken = mapboxToken;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v10',
            zoom: 4,
            center: [-98.4916, 29.4252],
            number: 7
        });

        //marker down below
        var marker = new mapboxgl.Marker({
            draggable: true,
            color: 'rgba(124,165,177,0.78)'
        })
            .setLngLat([-98.4916, 29.4252])
            .addTo(map);

        //dark sky variable
        var darkSkyMap = "https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyKey + "/29.4241,-98.4936";
        console.log(darkSkyMap);


        //icon array of objects
        var weather = [
            {
                type: "clear-day",
                image: "<img src='weather-icons/Sun.svg'>"
            },
            {
                type: "clear-night",
                image: "<img src='weather-icons/Moon.svg'>"
            },
            {
                type: "rain",
                image: "<img src='weather-icons/Cloud-Rain-Alt.svg'>"
            },
            {
                type: "snow",
                image: "<img src='weather-icons/Cloud-Snow-Alt.svg'>"
            },
            {
                type: "sleet",
                image: "<img src='weather-icons/Cloud-Hail.svg'>"
            },
            {
                type: "wind",
                image: "<img src='weather-icons/Cloud-Wind.svg'>"
            },
            {
                type: "fog",
                image: "<img src='weather-icons/Cloud-Fog-Alt.svg'>"
            },
            {
                type: "cloudy",
                image: "<img src='weather-icons/Cloud.svg'>"
            },
            {
                type: "partly-cloudy-day",
                image: "<img src='weather-icons/Cloud-Sun.svg'>"
            },
            {
                type: "partly-cloudy-night",
                image: "<img src='weather-icons/Cloud-Moon.svg'>"
            }
        ];


        //retrieve dark sky data function / variables / appending for cards

        function getDarkSkyData(darkSkyMap) {

            $.ajax(darkSkyMap).done(function (data) {
                $('.preloader-wrapper').hide();


                // MS IN A DAY FOR QUICK MATH
                var msInADay = 86400000;

                //DAILY DATA FOR EASY ACCESS
                var day = data.daily.data;

                //SHOW TODAY DATE
                var dayToday = new Date(getTime());


                //SHOWS TOMORROW DATE
                var dayTomorrow = (new Date(getTime() + msInADay));



                //SHOWS DAY AFTER TOMORROW DATE
                var dayAfterTom = (new Date(getTime() + msInADay * 2));
                console.log(dayAfterTom);

                //today card

                $('.row ').append("<div class='col s7 m4 center-align '>" +
                    "<div class='card blue-grey darken-1 waves-effect waves-dark white'>" +
                    "<div class='card-content white-text '>" +
                    dayToday + '<hr>' +
                    "<div>" +
                    "Temperature: " +
                    Math.round((day[0].temperatureHigh + day[0].temperatureLow) / 2) + "°" +
                    "</div>" +
                    "<div>" + "<hr>" +
                    "Clouds: " +
                    day[0].icon +
                    "</div>" +
                    "<div>" +
                    "Humidity: " +
                    Math.round(day[0].humidity * 100) +
                    "</div>" +
                    "<div>" +
                    "Wind: " +
                    day[0].windGust + " mph" +
                    "</div>" +
                    "<div>" +
                    "Pressure: " +
                    day[0].pressure +
                    "<div id='currentDay'>" +

                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</div>");

                //tomorrow card

                $('.row').append("<div class='col s7 m4 center-align'>" +
                    "<div class='card blue-grey darken-1 waves-effect waves-dark white'>" +
                    "<div class='card-content white-text'>" +
                    dayTomorrow + '<hr>' +
                    "<div>" +
                    "Temperature: " +
                    Math.round((day[1].temperatureHigh + day[1].temperatureLow) / 2) + "°" + "<hr>" +
                    "</div>" +
                    "<div>" +
                    "Clouds: " +
                    day[1].icon +
                    "</div>" +
                    "<div>" +
                    "Humidity: " +
                    Math.round(day[1].humidity * 100) +
                    "</div>" +
                    "<div>" +
                    "Wind: " +
                    day[1].windGust + " mph" +
                    "</div>" +
                    "<div>" +
                    "Pressure: " +
                    day[1].pressure +
                    "<div id='dayTomorrow'>" +

                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</div>");

                //day after tomorrow card

                $('.row').append("<div class='col s6 m4  center-align'>" +
                    "<div class='card blue-grey darken-1 waves-effect waves-dark white'>" +
                    "<div class='card-content white-text'>" +
                    dayAfterTom + '<hr>' +
                    "<div>" +
                    "Temperature: " +
                    Math.round((day[2].temperatureHigh + day[2].temperatureLow) / 2) + "°" + "<hr>" +
                    "</div>" +
                    "<div>" +
                    "Clouds: " +
                    day[2].icon +
                    "</div>" +
                    "<div>" +
                    "Humidity: " +
                    Math.round(day[2].humidity * 100) +
                    "</div>" +
                    "<div>" +
                    "Wind: " +
                    day[2].windGust + " mph" +
                    "</div>" +
                    "<div>" +
                    "Pressure: " +
                    day[2].pressure +
                    "<div id='dayAfter-card'>" +

                    "</div>" +
                    "</div>" +
                    "</div>" +
                    "</div>");

                //image loop logic

                weather.forEach(function (data) {
                    if (day[0].icon === data.type) {
                        $('#currentDay').html(data.image);
                    } else {
                        console.log('nice try buckaroo')
                    }
                });
                weather.forEach(function (data) {
                    if (day[1].icon === data.type) {
                        $('#dayTomorrow').html(data.image);
                    } else {
                        console.log('nice try buckaroo')
                    }
                });
                weather.forEach(function (data) {
                    if (day[2].icon === data.type) {
                        $('#dayAfter-card').html(data.image);
                    } else {
                        console.log('nice try buckaroo')
                    }
                });


            });

        }


        getDarkSkyData(darkSkyMap);
        geoCode(darkSkyMap);


        // marker drop logic

        marker.on('dragend', onDragEnd);

        function onDragEnd() {
            var lngLat = marker.getLngLat();
            console.log(lngLat);
            $(' .row ').html("");
            var weather = "https://cors-anywhere.herokuapp.com/https://api.darksky.net/forecast/" + darkSkyKey + "/" + lngLat.lat + "," + lngLat.lng;
            getDarkSkyData(weather);
        }

        //geocoder logic

        function geoCode() {
            $('#geoSearch').click(function (e) {
                e.preventDefault();
                var input = $('#input').val();
                console.log(input);
                geocode(input, mapboxToken).then(function (result) {
                    console.log(result);

                    map.flyTo({
                        center: result,
                        zoom: 7,
                        speed: 0.5
                    });
                    marker.setLngLat(result);

                    $(' .row ').html('');

                    onDragEnd();
                });
            });
        }


    });


</script>


</body>
</html>